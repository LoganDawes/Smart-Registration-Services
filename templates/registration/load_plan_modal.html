{% load static %}

<!-- Load Plan Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" 
     id="load-plan-modal"
     onclick="if(event.target === this) this.remove()">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl">
        <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-green-600">
            <h2 class="text-2xl font-bold text-white">Load Plan to Registration Cart</h2>
            <button onclick="document.getElementById('load-plan-modal').remove()" 
                    class="text-white hover:text-gray-200 text-3xl font-bold">
                &times;
            </button>
        </div>
        
        <div class="p-6">
            <p class="text-gray-700 mb-4">Select a plan to load all its courses into your registration cart:</p>
            
            {% if plans %}
            <div class="space-y-2 max-h-96 overflow-y-auto">
                {% for plan in plans %}
                <div class="p-4 border-2 {% if plan.status == 'APPROVED' %}border-green-500 bg-green-50{% else %}border-gray-300{% endif %} rounded-lg hover:border-green-500 hover:bg-green-50 cursor-pointer transition-colors"
                     onclick="loadPlanToCart({{ plan.id }})">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800 text-lg">{{ plan.name }}</h4>
                            <p class="text-sm text-gray-600 mt-1">{{ plan.term }} {{ plan.year }}</p>
                            <p class="text-sm text-gray-600">{{ plan.planned_courses.count }} courses | Total Credits: {{ plan.total_credits }}</p>
                            
                            <!-- Show courses in plan -->
                            <div class="mt-2 space-y-1">
                                {% for pc in plan.planned_courses.all|slice:":3" %}
                                <p class="text-xs text-gray-500">
                                    â€¢ {{ pc.section.course.course_code }} - {{ pc.section.course.title }}
                                </p>
                                {% endfor %}
                                {% if plan.planned_courses.count > 3 %}
                                <p class="text-xs text-gray-500">... and {{ plan.planned_courses.count|add:"-3" }} more</p>
                                {% endif %}
                            </div>
                        </div>
                        <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full ml-4
                            {% if plan.status == 'DRAFT' %}bg-gray-100 text-gray-800
                            {% elif plan.status == 'SUBMITTED' %}bg-blue-100 text-blue-800
                            {% elif plan.status == 'APPROVED' %}bg-green-100 text-green-800
                            {% elif plan.status == 'REJECTED' %}bg-red-100 text-red-800
                            {% endif %}">
                            {{ plan.get_status_display }}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8">
                <div class="text-6xl mb-4">ðŸ“‹</div>
                <p class="text-gray-600 text-lg mb-4">You don't have any plans yet.</p>
                <a href="{% url 'planning:schedule' %}" 
                   class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold inline-block">
                    Create a Plan
                </a>
            </div>
            {% endif %}
        </div>
        
        <div class="flex justify-end gap-3 p-6 border-t border-gray-200">
            <button onclick="document.getElementById('load-plan-modal').remove()"
                    class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-semibold">
                Cancel
            </button>
        </div>
    </div>
</div>

<script>
    function loadPlanToCart(planId) {
        fetch(`/registration/load-plan/${planId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Loaded ${data.count} course(s) from plan to your registration cart!`);
                document.getElementById('load-plan-modal').remove();
                location.reload();
            } else {
                alert(data.error || 'Failed to load plan');
            }
        })
        .catch(error => {
            alert('Error loading plan: ' + error.message);
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
