{% load static %}

<!-- Load Plan Modal -->
<div class="modal-overlay" 
     id="load-plan-modal"
     role="dialog"
     aria-modal="true"
     aria-labelledby="load-plan-title"
     onclick="if(event.target === this) closeLoadPlanModal()">
    <div class="modal-container">
        <div class="modal-header bg-gradient-to-r from-green-600 to-green-500">
            <h2 id="load-plan-title" class="modal-header-title">Load Plan to Cart</h2>
            <button onclick="closeLoadPlanModal()" 
                    class="modal-close-btn"
                    aria-label="Close modal"
                    type="button">
                &times;
            </button>
        </div>
        
        <div class="modal-body">
            <p class="text-gray-700 mb-6 text-lg">Select a plan to load all its courses into your registration cart:</p>
            
            {% if plans %}
            <div class="space-y-4 max-h-96 overflow-y-auto pr-2">
                {% for plan in plans %}
                <div class="p-6 border-2 {% if plan.status == 'APPROVED' %}border-green-500 bg-green-50{% else %}border-gray-300 bg-white{% endif %} rounded-xl hover:border-green-500 hover:shadow-md cursor-pointer transition-all"
                     onclick="loadPlanToCart({{ plan.id }})">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800 text-xl">{{ plan.name }}</h4>
                            <p class="text-gray-600 mt-2">{{ plan.term }} {{ plan.year }}</p>
                            <p class="text-gray-600 mt-1">
                                <span class="font-semibold">{{ plan.planned_courses.count }}</span> courses | 
                                <span class="font-semibold">{{ plan.total_credits }}</span> credits
                            </p>
                            
                            <!-- Show courses in plan -->
                            <div class="mt-3 space-y-1">
                                {% for pc in plan.planned_courses.all|slice:":3" %}
                                <p class="text-sm text-gray-600">
                                    â€¢ {{ pc.section.course.course_code }} - {{ pc.section.course.title }}
                                </p>
                                {% endfor %}
                                {% if plan.planned_courses.count > 3 %}
                                <p class="text-sm text-gray-500 font-semibold">+ {{ plan.planned_courses.count|add:"-3" }} more courses</p>
                                {% endif %}
                            </div>
                        </div>
                        <span class="inline-block px-4 py-2 text-sm font-bold rounded-full ml-4
                            {% if plan.status == 'DRAFT' %}bg-gray-200 text-gray-800
                            {% elif plan.status == 'SUBMITTED' %}bg-blue-200 text-blue-800
                            {% elif plan.status == 'APPROVED' %}bg-green-200 text-green-800
                            {% elif plan.status == 'REJECTED' %}bg-red-200 text-red-800
                            {% endif %}">
                            {{ plan.get_status_display }}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12 bg-gray-50 rounded-lg">
                <div class="text-6xl mb-4">ðŸ“‹</div>
                <p class="text-gray-600 text-lg mb-6">You don't have any plans yet.</p>
                <a href="{% url 'planning:schedule' %}" 
                   class="px-8 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold inline-block shadow-md hover:shadow-lg">
                    Create a Plan
                </a>
            </div>
            {% endif %}
        </div>
        
        <div class="modal-footer">
            <button onclick="closeLoadPlanModal()"
                    class="px-8 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-semibold">
                Cancel
            </button>
        </div>
    </div>
</div>

<script>
    // Store the element that opened the modal for focus restoration
    let loadPlanModalOpener = null;
    
    // Set opener when modal is opened
    if (!window.loadPlanModalOpened) {
        window.loadPlanModalOpened = true;
        loadPlanModalOpener = document.activeElement;
        
        // Lock body scroll
        const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
        document.body.style.setProperty('--scrollbar-width', scrollbarWidth + 'px');
        document.body.classList.add('modal-open');
    }
    
    function closeLoadPlanModal() {
        // Unlock body scroll
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('--scrollbar-width');
        
        const modal = document.getElementById('load-plan-modal');
        if (modal) {
            modal.remove();
        }
        
        // Restore focus to opener
        if (loadPlanModalOpener && loadPlanModalOpener.focus) {
            loadPlanModalOpener.focus();
        }
        
        window.loadPlanModalOpened = false;
    }
    
    function loadPlanToCart(planId) {
        fetch(`/registration/load-plan/${planId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Loaded ${data.count} course(s) from plan to your registration cart!`);
                closeLoadPlanModal();
                location.reload();
            } else {
                alert(data.error || 'Failed to load plan');
            }
        })
        .catch(error => {
            alert('Error loading plan: ' + error.message);
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeLoadPlanModal();
        }
    });
    
    // Trap focus within modal
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Tab') {
            const modal = document.getElementById('load-plan-modal');
            if (!modal) return;
            
            const focusableElements = modal.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];
            
            if (event.shiftKey && document.activeElement === firstElement) {
                event.preventDefault();
                lastElement.focus();
            } else if (!event.shiftKey && document.activeElement === lastElement) {
                event.preventDefault();
                firstElement.focus();
            }
        }
    });
</script>
