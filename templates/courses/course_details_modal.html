{% load static %}

<!-- Course Details Modal -->
<div class="modal-overlay" 
     id="course-details-modal"
     role="dialog"
     aria-modal="true"
     aria-labelledby="course-modal-title"
     onclick="if(event.target === this) closeCourseDetailsModal()">
    <div class="modal-container">
        <!-- Header -->
        <div class="modal-header">
            <div class="flex-1">
                <h2 id="course-modal-title" class="modal-header-title">{{ section.course.course_code }}</h2>
                <p class="modal-header-subtitle">{{ section.course.title }}</p>
            </div>
            <button onclick="closeCourseDetailsModal()" 
                    class="modal-close-btn"
                    aria-label="Close modal"
                    type="button">
                &times;
            </button>
        </div>
        
        <!-- Body -->
        <div class="modal-body">
            <!-- Section Info -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-orange-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 font-semibold">Section</p>
                    <p class="text-2xl font-bold text-orange-600">{{ section.section_number }}</p>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 font-semibold">Credits</p>
                    <p class="text-2xl font-bold text-orange-600">{{ section.course.credits }}</p>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 font-semibold">Term</p>
                    <p class="text-lg font-bold text-blue-600">{{ section.term }} {{ section.year }}</p>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 font-semibold">CRN</p>
                    <p class="text-lg font-bold text-blue-600">{{ section.crn|default:"N/A" }}</p>
                </div>
            </div>
            
            <!-- Description -->
            <div class="border-l-4 border-orange-500 pl-4 mb-6">
                <h3 class="text-lg font-bold text-gray-800 mb-2">Course Description</h3>
                <p class="text-gray-700 leading-relaxed">{{ section.course.description }}</p>
            </div>
            
            <!-- Schedule Details -->
            <div class="bg-gray-50 p-6 rounded-lg mb-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Schedule Information</h3>
                <div class="space-y-3">
                    <div class="flex items-start">
                        <svg class="w-6 h-6 text-orange-600 mr-3 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <div>
                            <p class="font-semibold text-gray-800">Meeting Days</p>
                            <p class="text-gray-600">{{ section.meeting_days }}</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <svg class="w-6 h-6 text-orange-600 mr-3 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <p class="font-semibold text-gray-800">Time</p>
                            <p class="text-gray-600">{{ section.start_time|time:"g:i A" }} - {{ section.end_time|time:"g:i A" }}</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <svg class="w-6 h-6 text-orange-600 mr-3 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <div>
                            <p class="font-semibold text-gray-800">Location</p>
                            <p class="text-gray-600">{{ section.location }}</p>
                            {% if section.campus %}
                            <p class="text-sm text-gray-500">{{ section.campus }}</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex items-start">
                        <svg class="w-6 h-6 text-orange-600 mr-3 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <div>
                            <p class="font-semibold text-gray-800">Instructor</p>
                            <p class="text-gray-600">
                                {% if section.instructor %}
                                    {{ section.instructor.get_full_name }}
                                {% else %}
                                    To Be Announced
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Enrollment Info -->
            <div class="bg-blue-50 p-6 rounded-lg mb-6">
                <h3 class="text-lg font-bold text-gray-800 mb-3">Enrollment Status</h3>
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Seats Available</p>
                        <p class="text-2xl font-bold text-blue-600">
                            {{ section.available_seats }} / {{ section.max_enrollment }}
                        </p>
                    </div>
                    <div class="text-right">
                        {% if section.is_full %}
                        <span class="inline-block px-4 py-2 bg-red-100 text-red-800 rounded-full font-semibold">
                            Full (Waitlist Available)
                        </span>
                        {% else %}
                        <span class="inline-block px-4 py-2 bg-green-100 text-green-800 rounded-full font-semibold">
                            Open
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Prerequisites -->
            {% if section.course.prerequisites.all %}
            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded mb-6">
                <h3 class="text-lg font-bold text-gray-800 mb-2">Prerequisites</h3>
                <ul class="list-disc list-inside space-y-1">
                    {% for prereq in section.course.prerequisites.all %}
                    <li class="text-gray-700">{{ prereq.course_code }} - {{ prereq.title }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            <!-- Restrictions -->
            {% if section.restrictions %}
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                <h3 class="text-lg font-bold text-gray-800 mb-2">Restrictions</h3>
                <p class="text-gray-700">{{ section.restrictions }}</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Footer Actions -->
        <div class="modal-footer">
            <button onclick="closeCourseDetailsModal()"
                    class="px-8 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-semibold">
                Close
            </button>
            <button onclick="addToPlan({{ section.id }})"
                    class="px-8 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold">
                <span class="mr-2">ðŸ“‹</span> Add to Plan
            </button>
            <button onclick="addToCart({{ section.id }})"
                    class="px-8 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-semibold">
                <span class="mr-2">ðŸ›’</span> Add to Cart
            </button>
        </div>
    </div>
</div>

<script>
    // Store the element that opened the modal for focus restoration
    let modalOpenerElement = null;
    
    // Set opener when modal is opened (call this from the opener)
    if (!window.courseDetailsModalOpened) {
        window.courseDetailsModalOpened = true;
        modalOpenerElement = document.activeElement;
        
        // Lock body scroll
        const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
        document.body.style.setProperty('--scrollbar-width', scrollbarWidth + 'px');
        document.body.classList.add('modal-open');
        
        // Focus on close button for accessibility
        setTimeout(() => {
            const closeBtn = document.querySelector('#course-details-modal .modal-close-btn');
            if (closeBtn) closeBtn.focus();
        }, 100);
    }
    
    function closeCourseDetailsModal() {
        // Unlock body scroll
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('--scrollbar-width');
        
        // Remove modal
        const modal = document.getElementById('course-details-modal');
        if (modal) {
            modal.remove();
        }
        
        // Restore focus to opener
        if (modalOpenerElement && modalOpenerElement.focus) {
            modalOpenerElement.focus();
        }
        
        window.courseDetailsModalOpened = false;
    }
    
    function addToPlan(sectionId) {
        // Close current modal
        closeCourseDetailsModal();
        
        // Open plan selector modal
        fetch(`/planning/select-plan-form/?section_id=${sectionId}`)
            .then(response => response.text())
            .then(html => {
                document.getElementById('modal-container').innerHTML = html;
            })
            .catch(error => {
                alert('Error loading plan selector: ' + error.message);
            });
    }
    
    function addToCart(sectionId) {
        fetch('/registration/add-to-cart/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ section_id: sectionId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Course added to cart successfully!');
                closeCourseDetailsModal();
            } else {
                alert(data.error || 'Failed to add course to cart');
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeCourseDetailsModal();
        }
    });
    
    // Trap focus within modal
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Tab') {
            const modal = document.getElementById('course-details-modal');
            if (!modal) return;
            
            const focusableElements = modal.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];
            
            if (event.shiftKey && document.activeElement === firstElement) {
                event.preventDefault();
                lastElement.focus();
            } else if (!event.shiftKey && document.activeElement === lastElement) {
                event.preventDefault();
                firstElement.focus();
            }
        }
    });
</script>
