{% load static %}

<!-- Create Plan Modal -->
<div class="modal-overlay" 
     id="create-plan-modal"
     role="dialog"
     aria-modal="true"
     aria-labelledby="create-plan-title"
     onclick="if(event.target === this) closeCreatePlanModal()">
    <div class="modal-container" style="max-width: 40rem;">
        <div class="modal-header">
            <h2 id="create-plan-title" class="modal-header-title">Create New Plan</h2>
            <button onclick="closeCreatePlanModal()" 
                    class="modal-close-btn"
                    aria-label="Close modal"
                    type="button">
                &times;
            </button>
        </div>
        
        <form hx-post="/api/plans/" 
              hx-target="#create-plan-modal"
              hx-swap="outerHTML"
              class="modal-body">
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Plan Name</label>
                    <input type="text" 
                           name="name" 
                           required
                           placeholder="e.g., Fall 2024 Schedule"
                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-600 focus:border-orange-600 transition-colors">
                </div>
                
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Term</label>
                        <select name="term" 
                                required
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-600 focus:border-orange-600 transition-colors">
                            <option value="">Select Term</option>
                            <option value="Fall">Fall</option>
                            <option value="Spring">Spring</option>
                            <option value="Summer">Summer</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Year</label>
                        <select name="year" 
                                required
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-600 focus:border-orange-600 transition-colors">
                            <option value="">Select Year</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Notes (Optional)</label>
                    <textarea name="notes" 
                              rows="4"
                              placeholder="Add any notes about this plan..."
                              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-600 focus:border-orange-600 transition-colors"></textarea>
                </div>
            </div>
        </form>
        
        <div class="modal-footer">
            <button type="button" 
                    onclick="closeCreatePlanModal()"
                    class="px-8 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-semibold">
                Cancel
            </button>
            <button type="submit"
                    form="create-plan-form"
                    class="px-8 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-semibold shadow-md hover:shadow-lg">
                Create Plan
            </button>
        </div>
    </div>
</div>

<script>
    // Store the element that opened the modal for focus restoration
    let createPlanModalOpener = null;
    
    // Set opener when modal is opened
    if (!window.createPlanModalOpened) {
        window.createPlanModalOpened = true;
        createPlanModalOpener = document.activeElement;
        
        // Lock body scroll
        const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
        document.body.style.setProperty('--scrollbar-width', scrollbarWidth + 'px');
        document.body.classList.add('modal-open');
        
        // Focus on first input for accessibility
        setTimeout(() => {
            const firstInput = document.querySelector('#create-plan-modal input[name="name"]');
            if (firstInput) firstInput.focus();
        }, 100);
    }
    
    function closeCreatePlanModal() {
        // Unlock body scroll
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('--scrollbar-width');
        
        const modal = document.getElementById('create-plan-modal');
        if (modal) {
            modal.remove();
        }
        
        // Restore focus to opener
        if (createPlanModalOpener && createPlanModalOpener.focus) {
            createPlanModalOpener.focus();
        }
        
        window.createPlanModalOpened = false;
    }
    
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'create-plan-modal') {
            alert('Plan created successfully!');
            closeCreatePlanModal();
            // Optionally reload the page to show the new plan
            setTimeout(() => location.reload(), 500);
        }
    });
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeCreatePlanModal();
        }
    });
    
    // Trap focus within modal
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Tab') {
            const modal = document.getElementById('create-plan-modal');
            if (!modal) return;
            
            const focusableElements = modal.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];
            
            if (event.shiftKey && document.activeElement === firstElement) {
                event.preventDefault();
                lastElement.focus();
            } else if (!event.shiftKey && document.activeElement === lastElement) {
                event.preventDefault();
                firstElement.focus();
            }
        }
    });
</script>
