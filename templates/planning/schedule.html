{% extends "base.html" %}

{% block title %}My Schedule - Smart Registration Services{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section rounded-lg shadow-lg p-8 mb-12">
    <h1 class="text-5xl font-bold mb-4">My Weekly Schedule</h1>
    <p class="text-xl text-gray-600">
        View your registered courses in a weekly calendar format.
    </p>
</div>

<div class="page-container">
    {% if user.is_student %}
    
    <!-- Summary Card -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">Course Summary</h2>
                <p class="text-gray-600 mt-2">
                    <span class="font-bold text-green-600">{{ enrollments|length }}</span> Registered Courses
                    {% if added_courses_sections %}
                    | <span class="font-bold text-blue-600">{{ added_courses_sections|length }}</span> Added Courses
                    {% endif %}
                </p>
                <p class="text-gray-600">Total Credits (Registered): <span class="font-bold text-orange-600">{{ total_credits }}</span></p>
            </div>
            <div class="flex gap-3">
                <a href="{% url 'courses:catalog' %}" 
                   class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                   data-testid="browse-course-catalog-btn">
                    Browse Course Catalog
                </a>
            </div>
        </div>
    </div>
    
    <!-- Legend -->
    <div class="bg-white rounded-lg shadow-lg p-4 mb-6" data-testid="schedule-legend">
        <div class="flex items-center gap-6 flex-wrap">
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded bg-gradient-to-br from-green-500 to-green-600"></div>
                <span class="text-sm font-semibold text-gray-700">Registered Courses</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded bg-gradient-to-br from-blue-500 to-blue-600"></div>
                <span class="text-sm font-semibold text-gray-700">Added Courses</span>
            </div>
        </div>
    </div>
    
    {% if enrollments or added_courses_sections %}
    <!-- Weekly Schedule Calendar -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <h3 class="text-2xl font-bold text-gray-800 mb-6">Weekly Schedule</h3>
        <div class="overflow-x-auto">
            <div class="min-w-[900px]">
                <!-- Days Header -->
                <div class="grid grid-cols-8 gap-1 mb-2">
                    <div class="p-3 text-center font-bold text-gray-700 bg-gray-100 rounded-lg">Time</div>
                    <div class="p-3 text-center font-bold text-orange-700 bg-orange-50 rounded-lg">Monday</div>
                    <div class="p-3 text-center font-bold text-orange-700 bg-orange-50 rounded-lg">Tuesday</div>
                    <div class="p-3 text-center font-bold text-orange-700 bg-orange-50 rounded-lg">Wednesday</div>
                    <div class="p-3 text-center font-bold text-orange-700 bg-orange-50 rounded-lg">Thursday</div>
                    <div class="p-3 text-center font-bold text-orange-700 bg-orange-50 rounded-lg">Friday</div>
                    <div class="p-3 text-center font-bold text-orange-700 bg-orange-50 rounded-lg">Saturday</div>
                    <div class="p-3 text-center font-bold text-orange-700 bg-orange-50 rounded-lg">Sunday</div>
                </div>
                
                <!-- Time Blocks (7 AM - 10 PM) -->
                {% for time_slot in time_slots %}
                <div class="grid grid-cols-8 gap-1 mb-1">
                    <!-- Time Label -->
                    <div class="p-3 text-center text-sm font-semibold bg-gray-100 rounded-lg text-gray-700">
                        {{ time_slot.display }} {{ time_slot.period }}
                    </div>
                    
                    <!-- Monday -->
                    <div class="p-2 bg-gray-50 border-2 border-gray-200 rounded-lg min-h-[70px] relative hover:bg-blue-50 transition-colors">
                        {% if schedule_data %}
                            {% for course in schedule_data.schedule.MON %}
                                {% if course.start_time.hour == time_slot.hour %}
                                <div class="{% if course.status == 'registered' %}bg-gradient-to-br from-green-500 to-green-600 event--registered{% else %}bg-gradient-to-br from-blue-500 to-blue-600 event--added{% endif %} text-white p-3 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer"
                                     data-testid="schedule-event"
                                     data-status="{{ course.status }}"
                                     title="{{ course.course_code }} - {{ course.course_title }}&#10;Section: {{ course.section_number }}&#10;{{ course.start_time|time:'g:i A' }} - {{ course.end_time|time:'g:i A' }}&#10;{{ course.location }}&#10;{{ course.instructor }}&#10;Status: {{ course.status|title }}">
                                    <div class="font-bold text-sm">{{ course.course_code }}</div>
                                    <div class="text-xs mt-1">{{ course.location }}</div>
                                    <div class="text-xs opacity-90">{{ course.start_time|time:"g:i A" }}</div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <!-- Tuesday -->
                    <div class="p-2 bg-gray-50 border-2 border-gray-200 rounded-lg min-h-[70px] relative hover:bg-blue-50 transition-colors">
                        {% if schedule_data %}
                            {% for course in schedule_data.schedule.TUE %}
                                {% if course.start_time.hour == time_slot.hour %}
                                <div class="{% if course.status == 'registered' %}bg-gradient-to-br from-green-500 to-green-600 event--registered{% else %}bg-gradient-to-br from-blue-500 to-blue-600 event--added{% endif %} text-white p-3 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer"
                                     data-testid="schedule-event"
                                     data-status="{{ course.status }}"
                                     title="{{ course.course_code }} - {{ course.course_title }}&#10;Section: {{ course.section_number }}&#10;{{ course.start_time|time:'g:i A' }} - {{ course.end_time|time:'g:i A' }}&#10;{{ course.location }}&#10;{{ course.instructor }}&#10;Status: {{ course.status|title }}">
                                    <div class="font-bold text-sm">{{ course.course_code }}</div>
                                    <div class="text-xs mt-1">{{ course.location }}</div>
                                    <div class="text-xs opacity-90">{{ course.start_time|time:"g:i A" }}</div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <!-- Wednesday -->
                    <div class="p-2 bg-gray-50 border-2 border-gray-200 rounded-lg min-h-[70px] relative hover:bg-blue-50 transition-colors">
                        {% if schedule_data %}
                            {% for course in schedule_data.schedule.WED %}
                                {% if course.start_time.hour == time_slot.hour %}
                                <div class="{% if course.status == 'registered' %}bg-gradient-to-br from-green-500 to-green-600 event--registered{% else %}bg-gradient-to-br from-blue-500 to-blue-600 event--added{% endif %} text-white p-3 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer"
                                     data-testid="schedule-event"
                                     data-status="{{ course.status }}"
                                     title="{{ course.course_code }} - {{ course.course_title }}&#10;Section: {{ course.section_number }}&#10;{{ course.start_time|time:'g:i A' }} - {{ course.end_time|time:'g:i A' }}&#10;{{ course.location }}&#10;{{ course.instructor }}&#10;Status: {{ course.status|title }}">
                                    <div class="font-bold text-sm">{{ course.course_code }}</div>
                                    <div class="text-xs mt-1">{{ course.location }}</div>
                                    <div class="text-xs opacity-90">{{ course.start_time|time:"g:i A" }}</div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <!-- Thursday -->
                    <div class="p-2 bg-gray-50 border-2 border-gray-200 rounded-lg min-h-[70px] relative hover:bg-blue-50 transition-colors">
                        {% if schedule_data %}
                            {% for course in schedule_data.schedule.THU %}
                                {% if course.start_time.hour == time_slot.hour %}
                                <div class="{% if course.status == 'registered' %}bg-gradient-to-br from-green-500 to-green-600 event--registered{% else %}bg-gradient-to-br from-blue-500 to-blue-600 event--added{% endif %} text-white p-3 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer"
                                     data-testid="schedule-event"
                                     data-status="{{ course.status }}"
                                     title="{{ course.course_code }} - {{ course.course_title }}&#10;Section: {{ course.section_number }}&#10;{{ course.start_time|time:'g:i A' }} - {{ course.end_time|time:'g:i A' }}&#10;{{ course.location }}&#10;{{ course.instructor }}&#10;Status: {{ course.status|title }}">
                                    <div class="font-bold text-sm">{{ course.course_code }}</div>
                                    <div class="text-xs mt-1">{{ course.location }}</div>
                                    <div class="text-xs opacity-90">{{ course.start_time|time:"g:i A" }}</div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <!-- Friday -->
                    <div class="p-2 bg-gray-50 border-2 border-gray-200 rounded-lg min-h-[70px] relative hover:bg-blue-50 transition-colors">
                        {% if schedule_data %}
                            {% for course in schedule_data.schedule.FRI %}
                                {% if course.start_time.hour == time_slot.hour %}
                                <div class="{% if course.status == 'registered' %}bg-gradient-to-br from-green-500 to-green-600 event--registered{% else %}bg-gradient-to-br from-blue-500 to-blue-600 event--added{% endif %} text-white p-3 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer"
                                     data-testid="schedule-event"
                                     data-status="{{ course.status }}"
                                     title="{{ course.course_code }} - {{ course.course_title }}&#10;Section: {{ course.section_number }}&#10;{{ course.start_time|time:'g:i A' }} - {{ course.end_time|time:'g:i A' }}&#10;{{ course.location }}&#10;{{ course.instructor }}&#10;Status: {{ course.status|title }}">
                                    <div class="font-bold text-sm">{{ course.course_code }}</div>
                                    <div class="text-xs mt-1">{{ course.location }}</div>
                                    <div class="text-xs opacity-90">{{ course.start_time|time:"g:i A" }}</div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <!-- Saturday -->
                    <div class="p-2 bg-gray-50 border-2 border-gray-200 rounded-lg min-h-[70px] relative hover:bg-blue-50 transition-colors">
                        {% if schedule_data %}
                            {% for course in schedule_data.schedule.SAT %}
                                {% if course.start_time.hour == time_slot.hour %}
                                <div class="{% if course.status == 'registered' %}bg-gradient-to-br from-green-500 to-green-600 event--registered{% else %}bg-gradient-to-br from-blue-500 to-blue-600 event--added{% endif %} text-white p-3 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer"
                                     data-testid="schedule-event"
                                     data-status="{{ course.status }}"
                                     title="{{ course.course_code }} - {{ course.course_title }}&#10;Section: {{ course.section_number }}&#10;{{ course.start_time|time:'g:i A' }} - {{ course.end_time|time:'g:i A' }}&#10;{{ course.location }}&#10;{{ course.instructor }}&#10;Status: {{ course.status|title }}">
                                    <div class="font-bold text-sm">{{ course.course_code }}</div>
                                    <div class="text-xs mt-1">{{ course.location }}</div>
                                    <div class="text-xs opacity-90">{{ course.start_time|time:"g:i A" }}</div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <!-- Sunday -->
                    <div class="p-2 bg-gray-50 border-2 border-gray-200 rounded-lg min-h-[70px] relative hover:bg-blue-50 transition-colors">
                        {% if schedule_data %}
                            {% for course in schedule_data.schedule.SUN %}
                                {% if course.start_time.hour == time_slot.hour %}
                                <div class="{% if course.status == 'registered' %}bg-gradient-to-br from-green-500 to-green-600 event--registered{% else %}bg-gradient-to-br from-blue-500 to-blue-600 event--added{% endif %} text-white p-3 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer"
                                     data-testid="schedule-event"
                                     data-status="{{ course.status }}"
                                     title="{{ course.course_code }} - {{ course.course_title }}&#10;Section: {{ course.section_number }}&#10;{{ course.start_time|time:'g:i A' }} - {{ course.end_time|time:'g:i A' }}&#10;{{ course.location }}&#10;{{ course.instructor }}&#10;Status: {{ course.status|title }}">
                                    <div class="font-bold text-sm">{{ course.course_code }}</div>
                                    <div class="text-xs mt-1">{{ course.location }}</div>
                                    <div class="text-xs opacity-90">{{ course.start_time|time:"g:i A" }}</div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Detailed Course List -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h3 class="text-2xl font-bold text-gray-800 mb-6">Course Details</h3>
        <div class="space-y-4">
            {% for enrollment in enrollments %}
            <div class="border-2 border-gray-200 rounded-lg p-5 hover:shadow-lg transition-shadow hover:border-orange-300">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h4 class="text-xl font-bold text-gray-800">
                            {{ enrollment.section.course.course_code }} - {{ enrollment.section.course.title }}
                        </h4>
                        <p class="text-gray-600 mt-2">
                            <span class="inline-block mr-4">
                                <strong>Section:</strong> {{ enrollment.section.section_number }}
                            </span>
                            <span class="inline-block mr-4">
                                <strong>Credits:</strong> {{ enrollment.section.course.credits }}
                            </span>
                            <span class="inline-block">
                                <strong>CRN:</strong> {{ enrollment.section.crn|default_if_none:"N/A"|default:"N/A" }}
                            </span>
                        </p>
                        <p class="text-gray-600 mt-1">
                            <strong>Schedule:</strong> 
                            {{ enrollment.section.meeting_days }} 
                            {{ enrollment.section.start_time|time:"g:i A" }} - 
                            {{ enrollment.section.end_time|time:"g:i A" }}
                        </p>
                        <p class="text-gray-600 mt-1">
                            <strong>Location:</strong> {{ enrollment.section.location }}
                            {% if enrollment.section.campus %}
                                ({{ enrollment.section.campus }})
                            {% endif %}
                        </p>
                        <p class="text-gray-600 mt-1">
                            <strong>Instructor:</strong> 
                            {% if enrollment.section.instructor %}
                                {{ enrollment.section.instructor.get_full_name }}
                            {% else %}
                                TBA
                            {% endif %}
                        </p>
                    </div>
                    <button 
                        onclick="dropCourse({{ enrollment.id }}, '{{ enrollment.section.course.course_code }}')"
                        class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold ml-4">
                        Drop Course
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    {% else %}
    <!-- No Enrollments -->
    <div class="bg-white rounded-lg shadow-lg p-12 text-center">
        <div class="text-6xl mb-4">ðŸ“…</div>
        <h3 class="text-2xl font-bold text-gray-800 mb-2">No Enrolled Courses</h3>
        <p class="text-gray-600 text-lg mb-6">
            You haven't registered for any courses yet. Browse the course catalog to get started!
        </p>
        <a href="{% url 'courses:catalog' %}" 
           class="inline-block px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-semibold">
            Browse Course Catalog
        </a>
    </div>
    {% endif %}
    
    {% else %}
    <!-- Non-student view -->
    <div class="bg-white rounded-lg shadow-lg p-12 text-center">
        <div class="text-6xl mb-4">ðŸ“…</div>
        <h3 class="text-2xl font-bold text-gray-800 mb-2">My Schedule</h3>
        <p class="text-gray-600 text-lg">
            This feature is available for students only.
        </p>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Drop course functionality
    function dropCourse(enrollmentId, courseCode) {
        if (!confirm(`Are you sure you want to drop ${courseCode}? This action cannot be undone.`)) {
            return;
        }
        
        fetch('/api/registration-actions/drop/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ enrollment_id: enrollmentId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert('Course dropped successfully!');
                location.reload();
            } else {
                alert(data.error || 'Failed to drop course');
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
